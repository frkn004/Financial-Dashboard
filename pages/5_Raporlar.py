import streamlit as stimport pandas as pdimport plotly.graph_objects as gofrom plotly.subplots import make_subplotsimport iofrom datetime import datetimefrom fpdf import FPDFimport smtplibfrom email.mime.text import MIMETextfrom email.mime.multipart import MIMEMultipartfrom email.mime.application import MIMEApplicationfrom utils.data_loader import calculate_metrics, get_expense_breakdownfrom utils.helpers import format_currencydef show_reports():    st.title("ğŸ“‹ Raporlar")    if 'data' not in st.session_state or st.session_state.data is None:        st.info("ğŸ‘† LÃ¼tfen sol menÃ¼den bir veri dosyasÄ± yÃ¼kleyin.")        return    data = st.session_state.data    # Rapor tÃ¼rÃ¼ seÃ§imi    report_type = st.selectbox(        "ğŸ“Š Rapor TÃ¼rÃ¼",        ["Ã–zet Rapor", "AylÄ±k Rapor", "Gider Raporu", "DetaylÄ± Rapor"]    )    if report_type == "Ã–zet Rapor":        show_summary_report(data)    elif report_type == "AylÄ±k Rapor":        show_monthly_report(data)    elif report_type == "Gider Raporu":        show_expense_report(data)    else:        show_detailed_report(data)def show_summary_report(data):    """Ã–zet rapor gÃ¶ster"""    st.subheader("ğŸ“ˆ Finansal Ã–zet")    metrics = calculate_metrics(data)    if metrics:        # Temel metrikler tablosu        summary_df = pd.DataFrame({            'Metrik': ['Toplam SatÄ±ÅŸ', 'Toplam Gider', 'Net Kar', 'Kar MarjÄ±'],            'DeÄŸer': [                format_currency(metrics['total_sales']),                format_currency(metrics['total_expenses']),                format_currency(metrics['profit']),                f"%{metrics['margin']:.2f}"            ]        })        st.dataframe(            summary_df,            hide_index=True,            use_container_width=True        )        # Grafikler        col1, col2 = st.columns(2)        with col1:            # Kar/Zarar grafiÄŸi            fig = go.Figure(data=[go.Bar(                x=['SatÄ±ÅŸ', 'Gider', 'Kar'],                y=[metrics['total_sales'], metrics['total_expenses'], metrics['profit']],                marker_color=['#2ECC71', '#E74C3C', '#3498DB']            )])            fig.update_layout(                title="Finansal Genel BakÄ±ÅŸ",                height=400            )            st.plotly_chart(fig, use_container_width=True)        with col2:            # DaÄŸÄ±lÄ±m pasta grafiÄŸi            fig = go.Figure(data=[go.Pie(                labels=['SatÄ±ÅŸ', 'Gider', 'Kar'],                values=[metrics['total_sales'], metrics['total_expenses'], metrics['profit']],                hole=.3            )])            fig.update_layout(                title="DaÄŸÄ±lÄ±m Analizi",                height=400            )            st.plotly_chart(fig, use_container_width=True)def show_monthly_report(data):    """AylÄ±k rapor gÃ¶ster"""    st.subheader("ğŸ“… AylÄ±k Performans Analizi")    metrics = calculate_metrics(data)    if metrics:        # AylÄ±k trend grafiÄŸi        fig = make_subplots(rows=2, cols=1, subplot_titles=("Gelir ve Gider", "Kar ve Kar MarjÄ±"))        months = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s',                  'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim'][:len(metrics['monthly_sales'])]        # Gelir ve Gider grafiÄŸi        fig.add_trace(            go.Bar(                name='SatÄ±ÅŸ',                x=months,                y=metrics['monthly_sales'],                marker_color='#2ECC71'            ),            row=1, col=1        )        fig.add_trace(            go.Bar(                name='Gider',                x=months,                y=metrics['monthly_expenses'],                marker_color='#E74C3C'            ),            row=1, col=1        )        # Kar ve Kar MarjÄ± grafiÄŸi        fig.add_trace(            go.Bar(                name='Kar',                x=months,                y=metrics['monthly_profits'],                marker_color='#3498DB'            ),            row=2, col=1        )        fig.add_trace(            go.Scatter(                name='Kar MarjÄ± (%)',                x=months,                y=metrics['monthly_margins'],                line=dict(color='#E67E22', width=2),                yaxis='y2'            ),            row=2, col=1        )        fig.update_layout(height=800, showlegend=True)        fig.update_yaxes(title_text="%", secondary_y=True, row=2, col=1)        st.plotly_chart(fig, use_container_width=True)        # AylÄ±k performans tablosu        monthly_df = pd.DataFrame({            'Ay': months,            'SatÄ±ÅŸ': metrics['monthly_sales'],            'Gider': metrics['monthly_expenses'],            'Kar': metrics['monthly_profits'],            'Kar MarjÄ± (%)': metrics['monthly_margins']        })        st.dataframe(            monthly_df,            column_config={                'SatÄ±ÅŸ': st.column_config.NumberColumn('SatÄ±ÅŸ', format="â‚º%d"),                'Gider': st.column_config.NumberColumn('Gider', format="â‚º%d"),                'Kar': st.column_config.NumberColumn('Kar', format="â‚º%d"),                'Kar MarjÄ± (%)': st.column_config.ProgressColumn(                    'Kar MarjÄ± (%)',                    format="%{value:.1f}%",                    min_value=0,                    max_value=100,                )            },            hide_index=True,            use_container_width=True        )def show_expense_report(data):    """Gider raporu gÃ¶ster"""    st.subheader("ğŸ’° Gider Analizi")    expense_data = get_expense_breakdown(data)    if expense_data is not None:        # Gider daÄŸÄ±lÄ±m grafiÄŸi        fig = go.Figure()        # En yÃ¼ksek 10 gider kalemi        top_expenses = expense_data.head(10)        fig.add_trace(go.Bar(            y=top_expenses['ESAS GÄ°DER YERÄ°'],            x=top_expenses['Genel Toplam'],            orientation='h',            marker=dict(                color=top_expenses['SatÄ±ÅŸ OranÄ±'],                colorscale='Viridis',                showscale=True,                colorbar=dict(title="SatÄ±ÅŸ OranÄ± (%)")            ),            text=[f"â‚º{x:,.0f}<br>(%{y:.1f})" for x, y in                  zip(top_expenses['Genel Toplam'], top_expenses['SatÄ±ÅŸ OranÄ±'])],            textposition='auto',        ))        fig.update_layout(            title="En YÃ¼ksek 10 Gider Kalemi",            height=500,            yaxis={'categoryorder': 'total ascending'},            xaxis_title="Tutar (TL)"        )        st.plotly_chart(fig, use_container_width=True)        # Gider tablosu        st.dataframe(            expense_data,            column_config={                'ESAS GÄ°DER YERÄ°': st.column_config.TextColumn('Gider Kalemi'),                'Genel Toplam': st.column_config.NumberColumn('Toplam Tutar', format="â‚º%d"),                'ORTALAMA': st.column_config.NumberColumn('AylÄ±k Ortalama', format="â‚º%d"),                'SatÄ±ÅŸ OranÄ±': st.column_config.ProgressColumn(                    'SatÄ±ÅŸ OranÄ±',                    format="%{value:.1f}%",                    min_value=0,                    max_value=100,                )            },            hide_index=True,            use_container_width=True        )def show_detailed_report(data):    """DetaylÄ± rapor gÃ¶ster ve dÄ±ÅŸa aktarma seÃ§enekleri sun"""    st.subheader("ğŸ“Š DetaylÄ± Finansal Rapor")    metrics = calculate_metrics(data)    expense_data = get_expense_breakdown(data)    if metrics and expense_data is not None:        # Excel iÃ§in veriler        excel_dict = {            'Ã–zet': pd.DataFrame({                'Metrik': ['Toplam SatÄ±ÅŸ', 'Toplam Gider', 'Net Kar', 'Kar MarjÄ±'],                'DeÄŸer': [                    format_currency(metrics['total_sales']),                    format_currency(metrics['total_expenses']),                    format_currency(metrics['profit']),                    f"%{metrics['margin']:.2f}"                ]            }),            'AylÄ±k Performans': pd.DataFrame({                'Ay': ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s',                       'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim'][:len(metrics['monthly_sales'])],                'SatÄ±ÅŸ': metrics['monthly_sales'],                'Gider': metrics['monthly_expenses'],                'Kar': metrics['monthly_profits'],                'Kar MarjÄ± (%)': metrics['monthly_margins']            }),            'Gider Analizi': expense_data        }        col1, col2 = st.columns(2)        with col1:            # Excel raporu            excel_data = export_to_excel(excel_dict)            if excel_data:                st.download_button(                    label="ğŸ“¥ Excel Raporu Ä°ndir",                    data=excel_data,                    file_name=f"finansal_rapor_{datetime.now().strftime('%Y%m%d')}.xlsx",                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"                )        with col2:            # PDF raporu            pdf_data = create_pdf_report(excel_dict)            if pdf_data:                st.download_button(                    label="ğŸ“¥ PDF Raporu Ä°ndir",                    data=pdf_data,                    file_name=f"finansal_rapor_{datetime.now().strftime('%Y%m%d')}.pdf",                    mime="application/pdf"                )        # E-posta gÃ¶nderme seÃ§eneÄŸi        st.markdown("---")        st.subheader("ğŸ“§ Raporu E-posta ile GÃ¶nder")        col1, col2 = st.columns(2)        with col1:            email = st.text_input("E-posta Adresi")        with col2:            report_format = st.selectbox(                "Rapor FormatÄ±",                ["Excel", "PDF", "Her Ä°kisi"]            )        if st.button("ğŸ“¤ Raporu GÃ¶nder"):            if email:                attachments = {}                if report_format in ["Excel", "Her Ä°kisi"]:                    attachments[f"finansal_rapor_{datetime.now().strftime('%Y%m%d')}.xlsx"] = excel_data                if report_format in ["PDF", "Her Ä°kisi"]:                    attachments[f"finansal_rapor_{datetime.now().strftime('%Y%m%d')}.pdf"] = pdf_data                if send_email_report(email, attachments):                    st.success("âœ… Rapor baÅŸarÄ±yla gÃ¶nderildi!")                else:                    st.error("âŒ Rapor gÃ¶nderilirken bir hata oluÅŸtu!")            else:                st.warning("âš ï¸ LÃ¼tfen bir e-posta adresi girin!")def export_to_excel(df_dict):    """Excel dosyasÄ± oluÅŸtur"""    output = io.BytesIO()    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:        for sheet_name, df in df_dict.items():            df.to_excel(writer, sheet_name=sheet_name, index=False)    return output.getvalue()def create_pdf_report(df_dict):    """PDF raporu oluÅŸtur"""    try:        pdf = FPDF()        pdf.add_page()        # BaÅŸlÄ±k        pdf.set_font("Arial", "B", 16)        pdf.cell(0, 10, "Finansal Rapor", ln=True, align='C')        pdf.ln(10)        # Her DataFrame iÃ§in tablo oluÅŸtur        for sheet_name, df in df_dict.items():            pdf.set_font("Arial", "B", 12)            pdf.cell(0, 10, sheet_name, ln=True)            pdf.ln(5)            pdf.set_font("Arial", "B", 10)            for col in df.columns:                pdf.cell(40, 10, str(col), 1)            pdf.ln()            pdf.set_font("Arial", "", 10)            for _, row in df.iterrows():                for item in row:                    pdf.cell(40, 10, str(item), 1)                pdf.ln()            pdf.ln(10)        return pdf.output(dest='S').encode('latin1')    except Exception as e:        st.error(f"PDF oluÅŸturma hatasÄ±: {str(e)}")        return Noneif __name__ == "__main__":    show_reports()